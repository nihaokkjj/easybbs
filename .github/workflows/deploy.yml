# 工作流名称，显示在 Actions 标签页
name: Deploy Static Site to GitHub Pages

# ----------------------------------------------------
# 1. 触发条件 (Triggers)
# ----------------------------------------------------
on:
  # 只有推送到 main 分支时才触发部署流程
  push:
    branches:
      - main
  
  # 允许手动在 GitHub 界面上触发
  workflow_dispatch:

# ----------------------------------------------------
# 2. 权限设置
# 必须配置，否则无法进行 Pages 部署
# ----------------------------------------------------
permissions:
  contents: read     # 允许读取仓库内容
  pages: write       # 允许写入 Pages 部署
  id-token: write    # 允许 Pages 部署进行身份验证

# ----------------------------------------------------
# 3. 作业定义 (Jobs)
# ----------------------------------------------------
jobs:
  # Job 1: 构建 (Build) - 负责环境设置、依赖安装和项目打包
  build:
    name: Build Project
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: 检出代码
      - name: Checkout Code
        uses: actions/checkout@v4

      # Step 2: 设置 Node.js 环境
      - name: Setup Node.js Environment
        uses: actions/setup-node@v4
        with:
          node-version: 22 # 您的项目使用的版本
          cache: 'pnpm'   # 启用 pnpm 缓存
      
      # ✅ Step 3: 强制安装 pnpm 并验证
      # 使用 npm 全局安装 pnpm，确保它一定在 PATH 中
      - name: Install pnpm (via npm global install)
        run: |
          npm install -g pnpm@8 # 安装 pnpm v8
          pnpm --version        # 验证 pnpm 是否安装成功
        
      # Step 4: 安装依赖
      - name: Install Dependencies
        run: pnpm install --frozen-lockfile --no-prefer-workspace
      
      # Step 5: 构建项目
      - name: Build Project
        # 实际运行：vue-tsc -b && vite build
        run: pnpm run build 
      
      # Step 6: 配置 GitHub Pages 环境
      - name: Setup Pages
        uses: actions/configure-pages@v5

      # Step 7: 上传构建产物
      - name: Upload Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          # 您的 Vite/Vue 项目默认输出目录通常是 dist
          path: './dist' 

  # Job 2: 部署 (Deploy) - 负责将构建产物部署到 GitHub Pages
  deploy:
    name: Deploy to Pages
    # 依赖于 build Job 成功
    needs: build 
    runs-on: ubuntu-latest
    
    # 部署环境和 URL 定义
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
      
    steps:
      # Step 1: 部署
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4 # 官方部署 Action
