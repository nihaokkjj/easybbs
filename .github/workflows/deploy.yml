# 工作流名称，显示在 Actions 标签页
name: Go Build and Release

# ----------------------------------------------------
# 1. 触发条件 (Triggers)
# ----------------------------------------------------
on:
  # 只有推送到 main 分支时才触发部署流程
  push:
    branches:
      - main

# ----------------------------------------------------
# 2. 权限设置
# 必须配置，否则无法进行 Pages 部署
# ----------------------------------------------------
permissions:
  contents: read     # 允许读取仓库内容
  pages: write       # 允许写入 Pages 部署
  id-token: write    # 允许 Pages 部署进行身份验证

# ----------------------------------------------------
# 3. 作业定义 (Jobs)
# ----------------------------------------------------
jobs:
  # Job 1: 构建 (Build) - 负责环境设置、依赖安装和项目打包
  build:
    name: Build Project
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: 检出代码
      - name: Checkout Code
        uses: actions/checkout@v4

      # Step 2: 设置 Node.js 环境
      - name: Setup Node.js Environment
        uses: actions/setup-node@v4
        with:
          node-version: '20' # 您的项目使用的版本
          cache: 'pnpm'   # 启用 pnpm 缓存
          
      # Step 4: 安装依赖
      - name: Install Dependencies
        run: pnpm install 
      
      # Step 5: 构建项目
      - name: Build Project
        # 实际运行：vue-tsc -b && vite build
        run: pnpm run build 
      
      - name: Set SSH agent
        uses: webfactory/ssh-agent@v0
        with:
          ssh-private-key: ${{ secrets.BBS_TOKEN }}

      # Step 7: 上传构建产物
      - name: Add SHH known hosts
        run: |
          ssh-keyscan -H 8.137.114.19 >>~/.ssh/known_hosts
        
      - name: Deploy vite-project Alibaba Cloud
        run: |
          scp -r ./dist/*root@8.137.114.19:/www/wwwroot/www.resgoing.com/case/vite-project
